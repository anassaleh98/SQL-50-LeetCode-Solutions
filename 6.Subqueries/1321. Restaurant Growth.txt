with DailyTotals as(
    select visited_on, sum(amount) as amount
    from Customer 
    group by visited_on
    ),
Average as(
    select d1.visited_on , sum(d2.amount) as amount , 
           round(avg(d2.amount), 2) as average_amount
    from DailyTotals d1
    join DailyTotals d2
    on d2.visited_on between date_sub(d1.visited_on, interval 6 day) and d1.visited_on
    group by d1.visited_on
)
select *
from Average
where visited_on >=(select min(visited_on) + interval 6 day from Average)
group by visited_on

-------------------------
WITH DailyTotals AS (
    SELECT visited_on, SUM(amount) AS amount
    FROM Customer
    GROUP BY visited_on
),
MovingAverage AS (
    SELECT 
        visited_on,
        SUM(amount) OVER (
            ORDER BY visited_on 
            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
        ) AS amount,
        ROUND(
            AVG(amount) OVER (
                ORDER BY visited_on 
                ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
            ), 2
        ) AS average_amount
    FROM DailyTotals
)
SELECT *
FROM MovingAverage
WHERE visited_on >= (
    SELECT MIN(visited_on) + INTERVAL 6 DAY FROM Customer
)
ORDER BY visited_on;
